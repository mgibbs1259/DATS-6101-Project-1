---
title: "Education Expenditure and Test Scores"
authors: Mary Gibbs and Rayhaan Rasheed
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

Project Overview
----------------

Data Source: https://www.kaggle.com/noriuk/us-educational-finances

Research Question: Is there a significant linear relationship between school expenditure and 4th/8th grade average math scores from 2005 to 2015?

Hypotheses:
H0: There is no significant linear relationship between school expenditure and 4th/8th grade average math scores from 2005 to 2015. B1 = 0. 
HA: There is a significant linear relationship between school expenditure and 4th/8th grade average math scores from 2005 to 2015. B1 != 0.

Data Preparation
----------------

Packages
```{r}
library(corrplot)
library(data.table)
library(dplyr)
library(ggfortify)
library(ggplot2)
library(ggvis)
library(grid)
library(plyr)
library(stats)
library(VIM)
```

Read in data
```{r}
finances <- fread("finances.csv")
scores <- fread("scores.csv")
```

Check data
```{r}
str(finances)
str(scores)
```

Clean data
```{r}
#choose columns of interest
finances <- finances[, c(1, 2, 4, 8)]
#select 2000 to 2015
finances <- finances[finances$YEAR > 2004 & finances$YEAR < 2016]
scores <- scores[scores$YEAR > 2004 & scores$YEAR < 2016]
#select mathematics
scores <- scores[scores$TEST_SUBJECT == 'Mathematics']
#join finances and scores on year and state
df <- merge(finances, scores, by = c("YEAR", "STATE"))
#make column names lowercase
df <- setnames(df, tolower(names(df)))
#remove rows with avg_score = "-" and avg_score = "‡"
df <- df[df$avg_score != "—" & df$avg_score != "‡"]
#change avg_score and test_year data types
df$avg_score <- as.numeric(df$avg_score, digits = 7)
df$test_year <- as.factor(df$test_year)
#check df 
str(df)
```

Exploratory Data Analysis
-------------------------

Summary
```{r}
#summarize df
summary(df)
```

Look at outliers
```{r}
#divide graph area into three columns
par(mfrow = c(1, 3))  
#boxplots of total revenue, total expenditure, and average math scores
boxplot(df$total_revenue, main = "Total Revenue")
boxplot(df$total_expenditure, main = "Total Expenditure")  
boxplot(df$avg_score, main = "Average Math Scores")
#total revenue and total expenditure have outliers
#remove total revenue and total expenditure outliers 
tr_outliers <- boxplot(df$total_revenue, plot = FALSE)$out
te_outliers <- boxplot(df$total_expenditure, plot = FALSE)$out
df <- df[!df$total_expenditure %in% c(tr_outliers, te_outliers)]
#divide graph area into three columns
par(mfrow = c(1, 2))  
#boxplots of total revenue (no outliers) and total expenditure (no outliers)
boxplot(df$total_revenue, main = "Total Revenue (No Outliers)")
boxplot(df$total_expenditure, main = "Total Expenditure (No Outliers)")
```

Look at normality 
```{r}
#divide graph area into three columns
par(mfrow = c(1, 3))  
#density plots of total revenue, total expenditure, and average math scores
plot(density(df$total_revenue), main = "Total Revenue", ylab = "Frequency", col = "darkolivegreen3")
polygon(density(df$total_revenue), col = "darkolivegreen3")
plot(density(df$total_expenditure), main = "Total Expenditure", ylab = "Frequency", col = "deepskyblue2")
polygon(density(df$total_expenditure), col = "deepskyblue2")
plot(density(df$avg_score), main = "Average Math Scores", ylab = "Frequency", col = "darkorchid3")
polygon(density(df$avg_score), col = "darkorchid3")
#total revenue and total expenditure have slight left skew
#average math scores are bimodal, which might be due to grade level differences

#check if average math scores are bimodal due to grade level differecnes
df_4 <- df[df$test_year == 4]
df_8 <- df[df$test_year == 8]
#divide graph area into two columns
par(mfrow = c(1, 2))  
#density plots of 4th grade average math scores and 8th grade average math scores
plot(density(df_4$avg_score), main = "4th Grade Average Math Scores", ylab = "Frequency", col = "indianred3")
polygon(density(df_4$avg_score), col = "indianred3")
plot(density(df_8$avg_score), main = "8th Grade Average Math Scores", ylab = "Frequency", col = "goldenrod1")
polygon(density(df_8$avg_score), col = "goldenrod1")
#average math scores are bimodal due to grade level differences
#treat 4th grade average math scores and 8th grade average math scores separate
```

Look at independence
```{r}
#covariance matrix for 4th grade
df_cov_4 <- cov(df_4[, 3:5], method = "pearson")
df_cov_4
#correlation matrix for 4th grade
df_cor_4 <- cor(df_4[, 3:5], method = "pearson")
df_cor_4
#correlation plot for 4th grade
corrplot(df_cor_4, method = "square", addCoef.col = "black", number.digits = 4, title = "4th Grade")

##covariance matrix for 8th grade
df_cov_8 <- cov(df_8[, 3:5], method = "pearson")
df_cov_8
#correlation matrix for 8th grade
df_cor_8 <- cor(df_8[, 3:5], method = "pearson")
df_cor_8
#correlation plot for 4th grade
corrplot(df_cor_8, method = "square", addCoef.col = "black", number.digits = 4, title = "8th Grade")

#all relationships are positive
#strong positive relationship between total revenue and total expenditure
#weak positive relationships between total revenue and average score and total expenditure and average score
```

Look at linearity 
```{r}
#scatter plot of 4th grade average math scores vs. total expenditure
ggplot(df_4, aes(x = total_expenditure, y = avg_score)) +
      geom_point(shape = 1) +    
      geom_smooth(method = lm, se = FALSE, color = "indianred3") + 
      ggtitle("4th Grade Average Math Test Scores vs. Total Expenditure") + 
      theme(plot.title = element_text(hjust = 0.5)) + 
      xlab("Total Expenditure") + 
      ylab("Average Score")
```

```{r}
#scatter plot of 8th grade average math scores vs. total expenditure
ggplot(df_8, aes(x = total_expenditure, y = avg_score)) +
      geom_point(shape = 1) +    
      geom_smooth(method = lm, se = FALSE, color = "goldenrod1") + 
      ggtitle("8th Grade Average Math Test Scores vs. Total Expenditure") + 
      theme(plot.title = element_text(hjust = 0.5)) + 
      xlab("Total Expenditure") + 
      ylab("Average Score")
```

```{r}
#scatter plot of 4th grade average math scores vs. (total revenue - total expenditure) 
df_4$tr_sub_te <- df_4$total_revenue - df_4$total_expenditure
ggplot(df_4, aes(x = tr_sub_te, y = avg_score)) +
      geom_point(shape = 1) +    
      geom_smooth(method = lm, se = FALSE, color = "darkseagreen3") + 
      ggtitle("4th Grade Average Math Test Scores vs. (Total Revenue - Total Expenditure)") + 
      theme(plot.title = element_text(hjust = 0.5)) + 
      xlab("Total Revenue - Total Expenditure") + 
      ylab("Average Score")
```

```{r}
#scatter plot of 8th grade average math scores vs. (total revenue - total expenditure) 
df_8$tr_sub_te <- df_8$total_revenue - df_8$total_expenditure
ggplot(df_8, aes(x = tr_sub_te, y = avg_score)) +
      geom_point(shape = 1) +    
      geom_smooth(method = lm, se = FALSE, color = "forestgreen") + 
      ggtitle("8th Grade Average Math Test Scores vs. (Total Revenue - Total Expenditure)") + 
      theme(plot.title = element_text(hjust = 0.5)) + 
      xlab("Total Revenue - Total Expenditure") + 
      ylab("Average Score")
```

Models
------

Linear regression of 4th grade average math scores vs. total expenditure
```{r}
#linear regression 4th grade average math scores vs. total expenditure 
lm_df_4_te <- lm(avg_score ~ total_expenditure, data = df_4)
summary(lm_df_4_te)
#coefficients - intercept p value < 0.05 and slope p value < 0.05, reject H0
#multiple R-squared - 5.659% of the variance in 4th grade average math scores can be explained by school expenditure, poor model
#F-statistic - p value < 0.05, model outperforms randomness

#diagnostic plots - check residuals
par(mfrow = c(2, 2))
plot(lm_df_4_te)
#linearity (yes) - the residuals vs fitted plot does not appear to have a fitted pattern and the red line is approximately horizontal at zero 
#normality (yes) - the normal Q-Q plot appears to approximately follow a straight line
#homoscedasticity (yes) - the scale-Location plot points are spread equally and the red line is approximately horizontal
```

Linear regression of 8th grade average math scores vs. total expenditure
```{r}
#linear regression 8th grade average math test scores vs. total expenditure
lm_df_8_te <- lm(avg_score ~ total_expenditure, data = df_8)
summary(lm_df_8_te)
#coefficients - intercept p value < 0.05 and slope p value < 0.05, reject H0
#multiple R-squared - 3.93% of the variance in 8th grade average math scores can be explained by school expenditure, poor model
#F-statistic - p value < 0.05, model outperforms randomness

#diagnostic plots - check residuals
par(mfrow = c(2, 2))
plot(lm_df_8_te)
#linearity (yes) - the residuals vs fitted plot does not appear to have a fitted pattern and the red line is approximately horizontal at zero 
#normality (yes) - the normal Q-Q plot appears to approximately follow a straight line
#homoscedasticity (yes) - the scale-Location plot points are spread equally and the red line is approximately horizontal
```
